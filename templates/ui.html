
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Sistema de Control de Mantenimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- CSS embebido -->
  <style>
    :root {
      --primary: #2563eb;      /* azul */
      --secondary: #6b7280;    /* gris */
      --danger: #dc2626;       /* rojo */
      --border: #ddd;          /* borde neutro */
      --bg: #f7fafc;           /* fondo app */
      --muted: #555;           /* textos secundarios */
      --shadow: 0 2px 4px rgba(0,0,0,.04);
      --shadow-modal: 0 8px 20px rgba(0,0,0,.25);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
      background: var(--bg);
      color: #222;
      line-height: 1.35;
    }

    /* Titulares y layout superior */
    h1 { margin: 0 0 12px; font-size: 22px; }
    h3 { margin: 0 0 8px; font-size: 18px; }
    .top {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap; /* mejor comportamiento en pantallas pequeñas */
    }
    .top #user { color: var(--muted); }

    /* Tarjetas / paneles */
    .card {
      background: #fff;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      box-shadow: var(--shadow);
    }
    .msg { margin-top: 8px; color: var(--muted); min-height: 20px; }

    /* Tablas */
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    thead th {
      background: #f3f3f3;
      text-align: left;
      border: 1px solid var(--border);
      padding: 8px;
      font-weight: 600;
    }
    tbody td {
      border: 1px solid var(--border);
      padding: 8px;
      vertical-align: middle;
    }
    tbody tr:hover { background: #f9fafb; }

    /* Botones */
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      transition: filter .15s ease;
    }
    .btn:hover { filter: brightness(0.95); }

    .btn-secondary {
      background: var(--secondary);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      transition: filter .15s ease;
    }
    .btn-secondary:hover { filter: brightness(0.95); }

    .btn-danger {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      transition: filter .15s ease;
    }
    .btn-danger:hover { filter: brightness(0.95); }

    /* Formularios en grid */
    form.grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      align-items: end;
    }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    select, input {
      padding: 6px;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #fff;
      font-size: 14px;
    }
    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      align-items: center;
    }
    .hidden { display: none !important; }

    /* -------------------- Modal embebido -------------------- */
    .modal-overlay {
      position: fixed;
      inset: 0; /* top, right, bottom, left = 0 */
      background: rgba(0,0,0,.4);
      display: none;            /* se mostrará con .show */
      align-items: center;      /* centrar vertical */
      justify-content: center;  /* centrar horizontal */
      z-index: 1000;
      padding: 12px;            /* margen interior para móviles */
    }
    .modal {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 480px;             /* tamaño modal */
      max-width: 95vw;          /* responsivo */
      padding: 12px;
      box-shadow: var(--shadow-modal);
      animation: modalIn .15s ease-out;
    }
    @keyframes modalIn {
      from { transform: translateY(8px); opacity: 0; }
      to   { transform: translateY(0);  opacity: 1; }
    }
    .modal h4 { margin: 0 0 8px; font-size: 16px; }
    .modal .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .modal .grid label { font-size: 12px; color: var(--muted); }
    .modal .grid input, .modal .grid select {
      padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 100%;
    }
    .modal .actions {
      display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;
    }
    .modal .msg { margin-top: 6px; min-height: 18px; color: var(--muted); }
    .modal-overlay.show { display: flex; }

    /* -------------------- Responsive -------------------- */
    @media (max-width: 980px) {
      form.grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      .top { flex-direction: column; align-items: flex-start; }
      form.grid { grid-template-columns: 1fr; }
      .actions { justify-content: flex-start; }
      .modal { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Barra superior -->
  <div class="top">
    <h1 style="flex:1">Sistema de Control de Mantenimiento</h1>
    <div id="user">Verificando sesión...</div>
    <button id="logout" class="btn-secondary">Cerrar sesión</button>
  </div>

  <!-- Tarjeta: Equipos -->
  <div class="card" id="panel_equipos">
    <h3>Equipos</h3>
    <form class="grid" id="formEq">
      <div>
        <label>Laboratorio</label>
        <select id="eq_lab"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Estado</label>
        <select id="eq_estado">
          <option value="">Todos</option>
          <option>operativo</option>
          <option>programado</option>
          <option>en_mantenimiento</option>
          <option>de_baja</option>
        </select>
      </div>
      <div>
        <label>Tipo</label>
        <input id="eq_tipo" placeholder="PC / Switch / ..." />
      </div>
      <div>
        <label>Marca</label>
        <input id="eq_marca" placeholder="Dell / Cisco / ..." />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="button" id="eq_aplicar" class="btn">Aplicar</button>
        <button type="button" id="eq_limpiar" class="btn-secondary">Limpiar</button>
      </div>
      <div id="eq_msg" class="msg" style="grid-column: span 4;"></div>
    </form>

    <table id="eq_table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Etiqueta</th>
          <th>Tipo</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Laboratorio</th>
          <!-- th.actions-eq se inserta si ROL === 'admin' -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Tarjeta: Crear equipo (solo admin) -->
  <div class="card hidden" id="admin_equipo">
    <h3>Crear equipo</h3>
    <form id="formEquipo" class="grid">
      <div>
        <label>Laboratorio</label>
        <select id="eq_lab_create"><option value="">Seleccione</option></select>
      </div>
      <div>
        <label>Etiqueta (única)</label>
        <input id="eq_etiqueta" placeholder="PC-RED-001" />
      </div>
      <div>
        <label>Tipo</label>
        <input id="eq_tipo_create" placeholder="PC / Switch / ..." />
      </div>
      <div>
        <label>Marca</label>
        <input id="eq_marca_create" placeholder="Dell / Cisco / ..." />
      </div>
      <div>
        <label>Modelo</label>
        <input id="eq_modelo_create" placeholder="OptiPlex 7000 / ..." />
      </div>
      <div>
        <label>Estado</label>
        <select id="eq_estado_create">
          <option>operativo</option>
          <option>programado</option>
          <option>en_mantenimiento</option>
          <option>de_baja</option>
        </select>
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="submit" class="btn">Crear equipo</button>
        <div class="msg" id="msgEquipo"></div>
      </div>
    </form>
  </div>

  <!-- Tarjeta: Programaciones próximas -->
  <div class="card" id="panel_proximas">
    <h3>Programaciones próximas</h3>
    <form class="grid" id="formProx">
      <div>
        <label>Laboratorio</label>
        <select id="prox_lab"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Días hasta</label>
        <input id="prox_hasta" type="number" min="1" max="365" value="60" />
      </div>
      <div>
        <label>Tipo</label>
        <input id="prox_tipo" placeholder="PC / Switch / ..." />
      </div>
      <div>
        <label>Marca</label>
        <input id="prox_marca" placeholder="Dell / Cisco / ..." />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="button" id="prox_aplicar" class="btn">Actualizar</button>
        <button type="button" id="prox_limpiar" class="btn-secondary">Limpiar</button>
      </div>
      <div id="prox_msg" class="msg" style="grid-column: span 4;"></div>
    </form>

    <table id="prox_table">
      <thead>
        <tr id="prox_header_row">
          <th>ID</th>
          <th>Equipo</th>
          <th>Laboratorio</th>
          <th>Fecha próxima</th>
          <th>Días restantes</th>
          <th>Periodicidad (días)</th>
          <!-- th.actions-th se inserta si ROL === 'admin' -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Tarjeta: Crear programación (solo admin) -->
  <div class="card hidden" id="admin_programacion">
    <h3>Crear programación (preventiva)</h3>
    <form id="formProgramacion" class="grid">
      <div>
        <label>Equipo</label>
        <select id="prog_equipo"><option value="">Seleccione</option></select>
      </div>
      <div>
        <label>Periodicidad (días)</label>
        <input id="prog_periodicidad" type="number" min="1" max="365" value="90" />
      </div>
      <div>
        <label>Fecha próxima</label>
        <input id="prog_fecha_proxima" type="date" />
      </div>
      <div>
        <label>Fecha última (opcional)</label>
        <input id="prog_fecha_ultima" type="date" />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="submit" class="btn">Crear programación</button>
        <div class="msg" id="msgProgramacion"></div>
      </div>
    </form>
  </div>

  <!-- Tarjeta: Mantenimientos -->
  <div class="card" id="panel_mantenimientos">
    <h3>Mantenimientos</h3>
    <form class="grid" id="formMantFilters">
      <div>
        <label>Equipo</label>
        <select id="mant_equipo"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Estado</label>
        <select id="mant_estado">
          <option value="">Todos</option>
          <option>abierto</option>
          <option>en_proceso</option>
          <option>cerrado</option>
        </select>
      </div>
      <div>
        <label>Tipo</label>
        <select id="mant_tipo">
          <option value="">Todos</option>
          <option>preventivo</option>
          <option>correctivo</option>
        </select>
      </div>
      <div>
        <label>Desde</label>
        <input id="mant_desde" type="date" />
      </div>
      <div>
        <label>Hasta</label>
        <input id="mant_hasta" type="date" />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="button" id="mant_aplicar" class="btn">Aplicar</button>
        <button type="button" id="mant_limpiar" class="btn-secondary">Limpiar</button>
      </div>
      <div id="mant_msg" class="msg" style="grid-column: span 4;"></div>
    </form>

    <table id="mant_table">
      <thead>
        <tr id="mant_header_row">
          <th>ID</th>
          <th>Equipo</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Apertura</th>
          <th>Cierre</th>
          <th>Descripción</th>
          <!-- Acciones admin -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Tarjeta: Crear mantenimiento (solo admin) -->
  <div class="card hidden" id="admin_mantenimiento">
    <h3>Crear mantenimiento</h3>
    <form id="formMantCreate" class="grid">
      <div>
        <label>Equipo</label>
        <select id="mant_equipo_create"><option value="">Seleccione</option></select>
      </div>
      <div>
        <label>Tipo</label>
        <select id="mant_tipo_create">
          <option>preventivo</option>
          <option>correctivo</option>
        </select>
      </div>
      <div>
        <label>Fecha apertura</label>
        <input id="mant_apertura_create" type="datetime-local" />
      </div>
      <div>
        <label>Fecha cierre (opcional)</label>
        <input id="mant_cierre_create" type="datetime-local" />
      </div>
      <div>
        <label>Estado</label>
        <select id="mant_estado_create">
          <option>abierto</option>
          <option>en_proceso</option>
          <option>cerrado</option>
        </select>
      </div>
      <div style="grid-column: span 4;">
        <label>Descripción</label>
        <input id="mant_desc_create" />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="submit" class="btn">Crear mantenimiento</button>
        <div class="msg" id="mant_create_msg"></div>
      </div>
    </form>
  </div>

  <!-- Tarjeta: Incidencias -->
  <div class="card" id="panel_incidencias">
    <h3>Incidencias</h3>
    <form class="grid" id="formIncFilters">
      <div>
        <label>Equipo</label>
        <select id="inc_equipo"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Severidad</label>
        <select id="inc_severidad">
          <option value="">Todas</option>
          <option>baja</option>
          <option>media</option>
          <option>alta</option>
        </select>
      </div>
      <div>
        <label>Mantenimiento (ID)</label>
        <input id="inc_mant_id" type="number" min="1" />
      </div>
      <div>
        <label>Desde</label>
        <input id="inc_desde" type="date" />
      </div>
      <div>
        <label>Hasta</label>
        <input id="inc_hasta" type="date" />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="button" id="inc_aplicar" class="btn">Aplicar</button>
        <button type="button" id="inc_limpiar" class="btn-secondary">Limpiar</button>
      </div>
      <div id="inc_msg" class="msg" style="grid-column: span 4;"></div>
    </form>

    <table id="inc_table">
      <thead>
        <tr id="inc_header_row">
          <th>ID</th>
          <th>Equipo</th>
          <th>Severidad</th>
          <th>Fecha reporte</th>
          <th>Descripción</th>
          <th>Reportada por</th>
          <th>Mantenimiento</th>
          <!-- Acciones admin -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Tarjeta: Crear incidencia (solo admin) -->
  <div class="card hidden" id="admin_incidencia">
    <h3>Crear incidencia</h3>
    <form id="formIncCreate" class="grid">
      <div>
        <label>Equipo</label>
        <select id="inc_equipo_create"><option value="">Seleccione</option></select>
      </div>
      <div>
        <label>Severidad</label>
        <select id="inc_severidad_create">
          <option>baja</option>
          <option>media</option>
          <option>alta</option>
        </select>
      </div>
      <div>
        <label>Fecha reporte</label>
        <input id="inc_fecha_create" type="datetime-local" />
      </div>
      <div style="grid-column: span 4;">
        <label>Descripción</label>
        <input id="inc_desc_create" />
      </div>
      <div>
        <label>Mantenimiento (opcional, ID)</label>
        <input id="inc_mant_id_create" type="number" min="1" />
      </div>
      <div class="actions" style="grid-column: span 4;">
        <button type="submit" class="btn">Crear incidencia</button>
        <div class="msg" id="inc_create_msg"></div>
      </div>
    </form>
  </div>

  <!-- Modal reutilizable embebido -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h4 id="modalTitle">Editar</h4>
      <div id="modalBody"></div>
      <div class="actions">
        <button id="modalCancel" class="btn-secondary">Cancelar</button>
        <button id="modalSave" class="btn">Guardar</button>
      </div>
      <div class="msg" id="modalMsg"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Estado global
    let ROL = 'solo_vista';
    let loadingProx = false;
    let eventsBound = false;

    // Utilidad: fetch JSON con manejo de errores robusto
    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, opts);
      let data;
      try { data = await res.json(); }
      catch { throw new Error(`Respuesta no válida de ${url}`); }
      if (!res.ok) {
        const msg = data?.error ?? data?.mensaje ?? data?.db_error ?? `HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        err.payload = data;
        throw err;
      }
      return data;
    }

    // Conversión datetime-local -> MySQL DATETIME
    function toMySQLDateTime(val) {
      // '2025-12-19T14:30' -> '2025-12-19 14:30:00'
      if (!val) return null;
      return val.replace('T', ' ') + ':00';
    }

    // -------- Modal reutilizable --------
    function openModal(title, bodyHTML, onSave) {
      const overlay = document.getElementById('modalOverlay');
      const titleEl = document.getElementById('modalTitle');
      const bodyEl  = document.getElementById('modalBody');
      const msgEl   = document.getElementById('modalMsg');
      const btnSave = document.getElementById('modalSave');
      const btnCancel = document.getElementById('modalCancel');

      titleEl.textContent = title || 'Editar';
      bodyEl.innerHTML = bodyHTML || '';
      msgEl.textContent = '';
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');

      function close() {
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
        msgEl.textContent = '';
        btnSave.removeEventListener('click', onSaveHandler);
        btnCancel.removeEventListener('click', onCancelHandler);
        document.removeEventListener('keydown', onEscHandler);
        overlay.removeEventListener('click', onOverlayClick);
      }

      async function onSaveHandler() {
        msgEl.textContent = 'Guardando...';
        try {
          await onSave(msgEl);
          msgEl.textContent = 'Guardado correctamente';
          setTimeout(close, 250);
        } catch (e) {
          msgEl.textContent = 'Error: ' + (e?.payload?.error ?? e.message ?? 'desconocido');
        }
      }
      function onCancelHandler() { close(); }
      function onEscHandler(ev) { if (ev.key === 'Escape') close(); }
      function onOverlayClick(ev) {
        const modal = document.querySelector('#modalOverlay .modal');
        if (!modal.contains(ev.target)) close();
      }

      btnSave.addEventListener('click', onSaveHandler);
      btnCancel.addEventListener('click', onCancelHandler);
      document.addEventListener('keydown', onEscHandler);
      overlay.addEventListener('click', onOverlayClick);
    }

    // /me para conocer rol y usuario
    async function me() { return fetchJSON('/me'); }

    // Cargar laboratorios en un <select> dado
    async function cargarLaboratorios(selectId) {
      const labs = await fetchJSON('/laboratorios');
      const el = document.getElementById(selectId);
      const firstOpt = (selectId === 'eq_lab_create')
                        ? 'Seleccione' : 'Todos';
      el.innerHTML = `<option value="">${firstOpt}</option>` +
        (Array.isArray(labs) ? labs.map(l => `<option value="${l.id}">${l.nombre}</option>`).join('') : '');
    }

    // Lista de Equipos (con filtros) + Acciones admin
    async function cargarEquipos() {
      const tbody = document.querySelector('#eq_table tbody');
      const msg = document.getElementById('eq_msg');
      tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
      msg.textContent = '';

      const lab = document.getElementById('eq_lab').value;
      const estado = document.getElementById('eq_estado').value;
      const tipo = document.getElementById('eq_tipo').value.trim();
      const marca = document.getElementById('eq_marca').value.trim();

      const params = new URLSearchParams();
      if (lab)    params.set('laboratorio_id', lab);
      if (estado) params.set('estado', estado);
      if (tipo)   params.set('tipo', tipo);
      if (marca)  params.set('marca', marca);

      try {
        const data = await fetchJSON('/equipos?' + params.toString());
        tbody.innerHTML = '';
        if (!Array.isArray(data)) throw new Error('Respuesta inválida (equipos)');

        // Header: columna Acciones (solo admin)
        const header = document.querySelector('#eq_table thead tr');
        const hasActionsThEq = header.querySelector('th.actions-eq');
        if (ROL === 'admin' && !hasActionsThEq) {
          header.insertAdjacentHTML('beforeend', '<th class="actions-eq">Acciones</th>');
        } else if (ROL !== 'admin' && hasActionsThEq) {
          hasActionsThEq.remove();
        }

        const includeActionsEq = (ROL === 'admin');
        data.forEach(e => {
          const accionesHTML = includeActionsEq
            ? `<button class="btn-secondary btn-edit-eq" data-id="${e.id}" data-labid="${e.laboratorio_id}">Editar</button>
               <button class="btn-danger btn-del-eq" data-id="${e.id}">Eliminar</button>`
            : '';
          const accionesTd = includeActionsEq ? `<td>${accionesHTML}</td>` : '';
          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${e.id ?? ''}</td>
              <td>${e.etiqueta_activo ?? ''}</td>
              <td>${e.tipo ?? ''}</td>
              <td>${e.marca ?? ''}</td>
              <td>${e.modelo ?? ''}</td>
              <td>${e.estado ?? ''}</td>
              <td>${e.laboratorio ?? ''}</td>
              ${accionesTd}
            </tr>
          `);
        });

        if (data.length === 0) {
          const colspan = includeActionsEq ? 8 : 7;
          tbody.innerHTML = `<tr><td colspan="${colspan}">Sin datos</td></tr>`;
        }
      } catch (e) {
        msg.textContent = 'Error: ' + (e.payload?.error ?? e.message ?? 'desconocido');
      }
    }

    // Vista de Programaciones próximas (con candado anti-doble carga) + Acciones admin
    async function cargarProximas() {
      if (loadingProx) return; // evita duplicado
      loadingProx = true;

      const tbody = document.querySelector('#prox_table tbody');
      const msg   = document.getElementById('prox_msg');
      tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
      msg.textContent = '';

      const lab   = document.getElementById('prox_lab').value;
      const hasta = document.getElementById('prox_hasta').value || 60;
      const tipo  = document.getElementById('prox_tipo').value.trim();
      const marca = document.getElementById('prox_marca').value.trim();

      const params = new URLSearchParams();
      params.set('hasta_dias', hasta);
      if (lab)   params.set('laboratorio_id', lab);
      if (tipo)  params.set('tipo', tipo);
      if (marca) params.set('marca', marca);

      try {
        const data = await fetchJSON('/programaciones/proximas?' + params.toString());
        tbody.innerHTML = '';

        if (!Array.isArray(data)) throw new Error('Respuesta inválida (programaciones próximas)');

        // Si es admin, añade/elimina columna Acciones en header
        const headerRow = document.getElementById('prox_header_row');
        const hasActionsTh = headerRow.querySelector('th.actions-th');
        if (ROL === 'admin' && !hasActionsTh) {
          headerRow.insertAdjacentHTML('beforeend', '<th class="actions-th">Acciones</th>');
        } else if (ROL !== 'admin' && hasActionsTh) {
          hasActionsTh.remove();
        }

        const includeActions = (ROL === 'admin');
        data.forEach(row => {
          const accionesHTML = includeActions
            ? `<button class="btn-secondary btn-edit-prog"
                        data-id="${row.id}"
                        data-periodicidad="${row.periodicidad_dias}"
                        data-fecha-proxima="${row.fecha_proxima || ''}"
                        data-fecha-ultima="${row.fecha_ultima || ''}">Editar</button>
               <button class="btn-danger btn-del-prog" data-id="${row.id}">Eliminar</button>`
            : '';
          const accionesTd = includeActions ? `<td>${accionesHTML}</td>` : '';

          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${row.id ?? ''}</td>
              <td>${row.etiqueta_activo ?? ''}</td>
              <td>${row.laboratorio ?? ''}</td>
              <td>${row.fecha_proxima ?? ''}</td>
              <td>${row.dias_restantes ?? ''}</td>
              <td>${row.periodicidad_dias ?? ''}</td>
              ${accionesTd}
            </tr>
          `);
        });

        if (data.length === 0) {
          const colspan = includeActions ? 7 : 6;
          tbody.innerHTML = `<tr><td colspan="${colspan}">Sin programaciones próximas en ${hasta} días</td></tr>`;
        }
      } catch (e) {
        msg.textContent = 'Error: ' + (e.payload?.error ?? e.message ?? 'desconocido');
      } finally {
        loadingProx = false;
      }
    }

    // Mantenimientos: cargar/crear/editar/eliminar
    async function cargarMantenimientos() {
      const tbody = document.querySelector('#mant_table tbody');
      const msg   = document.getElementById('mant_msg');
      tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
      msg.textContent = '';

      const eq    = document.getElementById('mant_equipo').value;
      const estado= document.getElementById('mant_estado').value;
      const tipo  = document.getElementById('mant_tipo').value;
      const desde = document.getElementById('mant_desde').value;
      const hasta = document.getElementById('mant_hasta').value;

      const params = new URLSearchParams();
      if (eq)    params.set('equipo_id', eq);
      if (estado)params.set('estado', estado);
      if (tipo)  params.set('tipo', tipo);
      if (desde) params.set('desde', desde);
      if (hasta) params.set('hasta', hasta);

      try {
        const data = await fetchJSON('/mantenimientos?' + params.toString());
        tbody.innerHTML = '';

        // Header Acciones (admin)
        const headerRow = document.getElementById('mant_header_row');
        const hasActionsTh = headerRow.querySelector('th.actions-mant');
        if (ROL === 'admin' && !hasActionsTh) {
          headerRow.insertAdjacentHTML('beforeend', '<th class="actions-mant">Acciones</th>');
        } else if (ROL !== 'admin' && hasActionsTh) {
          hasActionsTh.remove();
        }

        const includeActions = (ROL === 'admin');
        data.forEach(r => {
          const accionesHTML = includeActions
            ? `<button class="btn-secondary btn-edit-mant"
                        data-id="${r.id}"
                        data-equipo="${r.equipo_id}"
                        data-tipo="${r.tipo}"
                        data-estado="${r.estado}"
                        data-apertura="${r.fecha_apertura || ''}"
                        data-cierre="${r.fecha_cierre || ''}"
                        data-desc="${(r.descripcion || '').replace(/"/g,'&quot;')}">Editar</button>
               <button class="btn-danger btn-del-mant" data-id="${r.id}">Eliminar</button>`
            : '';
          const accionesTd = includeActions ? `<td>${accionesHTML}</td>` : '';

          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${r.id}</td>
              <td>${r.etiqueta_activo}</td>
              <td>${r.tipo}</td>
              <td>${r.estado}</td>
              <td>${r.fecha_apertura || ''}</td>
              <td>${r.fecha_cierre || ''}</td>
              <td>${r.descripcion || ''}</td>
              ${accionesTd}
            </tr>
          `);
        });

        if (data.length === 0) {
          const colspan = includeActions ? 8 : 7;
          tbody.innerHTML = `<tr><td colspan="${colspan}">Sin mantenimientos</td></tr>`;
        }
      } catch (e) {
        msg.textContent = 'Error: ' + (e.payload?.error ?? e.message ?? 'desconocido');
      }
    }

    // Incidencias: cargar/crear/editar/eliminar
    async function cargarIncidencias() {
      const tbody = document.querySelector('#inc_table tbody');
      const msg   = document.getElementById('inc_msg');
      tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
      msg.textContent = '';

      const eq     = document.getElementById('inc_equipo').value;
      const sev    = document.getElementById('inc_severidad').value;
      const mantId = document.getElementById('inc_mant_id').value;
      const desde  = document.getElementById('inc_desde').value;
      const hasta  = document.getElementById('inc_hasta').value;

      const params = new URLSearchParams();
      if (eq)     params.set('equipo_id', eq);
      if (sev)    params.set('severidad', sev);
      if (mantId) params.set('mantenimiento_id', mantId);
      if (desde)  params.set('desde', desde);
      if (hasta)  params.set('hasta', hasta);

      try {
        const data = await fetchJSON('/incidencias?' + params.toString());
        tbody.innerHTML = '';

        // Header Acciones (admin)
        const headerRow = document.getElementById('inc_header_row');
        const hasActionsTh = headerRow.querySelector('th.actions-inc');
        if (ROL === 'admin' && !hasActionsTh) {
          headerRow.insertAdjacentHTML('beforeend', '<th class="actions-inc">Acciones</th>');
        } else if (ROL !== 'admin' && hasActionsTh) {
          hasActionsTh.remove();
        }

        const includeActions = (ROL === 'admin');
        data.forEach(r => {
          const accionesHTML = includeActions
            ? `<button class="btn-secondary btn-edit-inc"
                        data-id="${r.id}"
                        data-equipo="${r.equipo_id}"
                        data-sev="${r.severidad}"
                        data-fecha="${(r.fecha_reporte || '').replace(' ', 'T').slice(0,16)}"
                        data-desc="${(r.descripcion || '').replace(/"/g,'&quot;')}"
                        data-mant="${r.mantenimiento_id || ''}">Editar</button>
               <button class="btn-danger btn-del-inc" data-id="${r.id}">Eliminar</button>`
            : '';
          const accionesTd = includeActions ? `<td>${accionesHTML}</td>` : '';

          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${r.id}</td>
              <td>${r.etiqueta_activo}</td>
              <td>${r.severidad}</td>
              <td>${r.fecha_reporte || ''}</td>
              <td>${r.descripcion || ''}</td>
              <td>${r.reportada_por_usuario || r.reportada_por || ''}</td>
              <td>${r.mantenimiento_id || ''}</td>
              ${accionesTd}
            </tr>
          `);
        });

        if (data.length === 0) {
          const colspan = includeActions ? 8 : 7;
          tbody.innerHTML = `<tr><td colspan="${colspan}">Sin incidencias</td></tr>`;
        }
      } catch (e) {
        msg.textContent = 'Error: ' + (e.payload?.error ?? e.message ?? 'desconocido');
      }
    }

    // Mostrar/ocultar paneles admin según rol
    function toggleAdminPanels(rol) {
      const show = (rol === 'admin');
      document.getElementById('admin_equipo').classList.toggle('hidden', !show);
      document.getElementById('admin_programacion').classList.toggle('hidden', !show);
      document.getElementById('admin_mantenimiento').classList.toggle('hidden', !show);
      document.getElementById('admin_incidencia').classList.toggle('hidden', !show);
    }

    // Combos para paneles admin (laboratorios / equipos / filtros)
    async function cargarCombosAdmin() {
      // Laboratorios para crear equipo
      const labs = await fetchJSON('/laboratorios');
      const labCreate = document.getElementById('eq_lab_create');
      labCreate.innerHTML = '<option value="">Seleccione</option>' +
        (Array.isArray(labs) ? labs.map(l => `<option value="${l.id}">${l.nombre}</option>`).join('') : '');

      // Equipos para crear programación (sin filtros)
      const equipos = await fetchJSON('/equipos');
      const progEquipo = document.getElementById('prog_equipo');
      progEquipo.innerHTML = '<option value="">Seleccione</option>' +
        (Array.isArray(equipos) ? equipos.map(e => `<option value="${e.id}">${e.etiqueta_activo} (${e.laboratorio})</option>`).join('') : '');

      // Equipos para crear mantenimiento/incidencia
      const mantEqSel = document.getElementById('mant_equipo_create');
      const incEqSel  = document.getElementById('inc_equipo_create');
      if (mantEqSel) mantEqSel.innerHTML = '<option value="">Seleccione</option>' +
        (Array.isArray(equipos) ? equipos.map(e => `<option value="${e.id}">${e.etiqueta_activo} (${e.laboratorio})</option>`).join('') : '');
      if (incEqSel) incEqSel.innerHTML = '<option value="">Seleccione</option>' +
        (Array.isArray(equipos) ? equipos.map(e => `<option value="${e.id}">${e.etiqueta_activo} (${e.laboratorio})</option>`).join('') : '');

      // Equipos en filtros de mantenimientos e incidencias
      const mantEqFilter = document.getElementById('mant_equipo');
      const incEqFilter  = document.getElementById('inc_equipo');
      if (mantEqFilter) mantEqFilter.innerHTML = '<option value="">Todos</option>' +
        (Array.isArray(equipos) ? equipos.map(e => `<option value="${e.id}">${e.etiqueta_activo}</option>`).join('') : '');
      if (incEqFilter) incEqFilter.innerHTML = '<option value="">Todos</option>' +
        (Array.isArray(equipos) ? equipos.map(e => `<option value="${e.id}">${e.etiqueta_activo}</option>`).join('') : '');
    }

    // Bind de eventos (una sola vez)
    function bindEventsOnce() {
      if (eventsBound) return;
      eventsBound = true;

      // Equipos: aplicar / limpiar
      document.getElementById('eq_aplicar').addEventListener('click', cargarEquipos);
      document.getElementById('eq_limpiar').addEventListener('click', async () => {
        document.getElementById('eq_lab').value = '';
        document.getElementById('eq_estado').value = '';
        document.getElementById('eq_tipo').value = '';
        document.getElementById('eq_marca').value = '';
        await cargarEquipos();
      });

      // Proximas: aplicar / limpiar
      document.getElementById('prox_aplicar').addEventListener('click', cargarProximas);
      document.getElementById('prox_limpiar').addEventListener('click', async () => {
        document.getElementById('prox_lab').value = '';
        document.getElementById('prox_hasta').value = 60;
        document.getElementById('prox_tipo').value = '';
        document.getElementById('prox_marca').value = '';
        await cargarProximas();
      });

      // Crear equipo
      document.getElementById('formEquipo').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msgEquipo');
        msg.textContent = 'Creando...';

        const payload = {
          etiqueta_activo: document.getElementById('eq_etiqueta').value.trim(),
          laboratorio_id: parseInt(document.getElementById('eq_lab_create').value),
          tipo:  document.getElementById('eq_tipo_create').value.trim() || null,
          marca: document.getElementById('eq_marca_create').value.trim() || null,
          modelo: document.getElementById('eq_modelo_create').value.trim() || null,
          estado: document.getElementById('eq_estado_create').value
        };
        if (!payload.etiqueta_activo || !payload.laboratorio_id) {
          msg.textContent = 'Faltan campos obligatorios';
          return;
        }

        try {
          const r = await fetchJSON('/equipos', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          msg.textContent = 'Creado (ID ' + r.id + ')';
          await cargarEquipos();
          await cargarCombosAdmin();
        } catch (e2) {
          msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
        }
      });

      // Crear programación
      document.getElementById('formProgramacion').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msgProgramacion');
        msg.textContent = 'Creando...';

        const payload = {
          equipo_id: parseInt(document.getElementById('prog_equipo').value),
          periodicidad_dias: parseInt(document.getElementById('prog_periodicidad').value),
          fecha_proxima: document.getElementById('prog_fecha_proxima').value || null,
          fecha_ultima:  document.getElementById('prog_fecha_ultima').value || null
        };
        if (!payload.equipo_id || !payload.periodicidad_dias || !payload.fecha_proxima) {
          msg.textContent = 'Faltan campos obligatorios';
          return;
        }

        try {
          const r = await fetchJSON('/programaciones', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          msg.textContent = 'Creada (ID ' + r.id + ')';
          await cargarProximas();
        } catch (e2) {
          msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
        }
      });

      // Crear mantenimiento
      document.getElementById('formMantCreate')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('mant_create_msg');
        msg.textContent = 'Creando...';

        const payload = {
          equipo_id: parseInt(document.getElementById('mant_equipo_create').value),
          tipo: document.getElementById('mant_tipo_create').value,
          fecha_apertura: toMySQLDateTime(document.getElementById('mant_apertura_create').value),
          fecha_cierre:  toMySQLDateTime(document.getElementById('mant_cierre_create').value) || null,
          estado: document.getElementById('mant_estado_create').value,
          descripcion: document.getElementById('mant_desc_create').value || null
        };
        if (!payload.equipo_id || !payload.tipo || !payload.fecha_apertura) {
          msg.textContent = 'Faltan campos obligatorios'; return;
        }

        try {
          const r = await fetchJSON('/mantenimientos', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          msg.textContent = 'Creado (ID ' + r.id + ')';
          await cargarMantenimientos();
        } catch (e2) {
          msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
        }
      });

      // Crear incidencia (intenta tomar reportada_por de /me)
      document.getElementById('formIncCreate')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('inc_create_msg');
        msg.textContent = 'Creando...';

        let reportada_por_id = null;
        try {
          const info = await fetchJSON('/me');
          reportada_por_id = info?.usuario?.id || null;
        } catch {}

        const payload = {
          equipo_id: parseInt(document.getElementById('inc_equipo_create').value),
          fecha_reporte: toMySQLDateTime(document.getElementById('inc_fecha_create').value),
          severidad: document.getElementById('inc_severidad_create').value,
          descripcion: document.getElementById('inc_desc_create').value || null,
          mantenimiento_id: parseInt(document.getElementById('inc_mant_id_create').value) || null,
          reportada_por: reportada_por_id
        };
        if (!payload.equipo_id || !payload.fecha_reporte || !payload.severidad) {
          msg.textContent = 'Faltan campos obligatorios'; return;
        }

        try {
          const r = await fetchJSON('/incidencias', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          msg.textContent = 'Creada (ID ' + r.id + ')';
          await cargarIncidencias();
        } catch (e2) {
          msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
        }
      });

      // Filtros: mantenimientos
      document.getElementById('mant_aplicar').addEventListener('click', cargarMantenimientos);
      document.getElementById('mant_limpiar').addEventListener('click', async () => {
        document.getElementById('mant_equipo').value = '';
        document.getElementById('mant_estado').value = '';
        document.getElementById('mant_tipo').value = '';
        document.getElementById('mant_desde').value = '';
        document.getElementById('mant_hasta').value = '';
        await cargarMantenimientos();
      });

      // Filtros: incidencias
      document.getElementById('inc_aplicar').addEventListener('click', cargarIncidencias);
      document.getElementById('inc_limpiar').addEventListener('click', async () => {
        document.getElementById('inc_equipo').value = '';
        document.getElementById('inc_severidad').value = '';
        document.getElementById('inc_mant_id').value = '';
        document.getElementById('inc_desde').value = '';
        document.getElementById('inc_hasta').value = '';
        await cargarIncidencias();
      });

      // Logout
      document.getElementById('logout').addEventListener('click', async () => {
        try { await fetchJSON('/logout', { method: 'POST' }); } catch {}
        window.location.href = '/login-ui';
      });

      // Delegación global: editar/eliminar programaciones, mantenimientos, incidencias y equipos
      document.addEventListener('click', async (ev) => {
        // EDITAR programación
        const btnEditProg = ev.target.closest('.btn-edit-prog');
        if (btnEditProg) {
          const id = btnEditProg.getAttribute('data-id');
          const periodicidad = btnEditProg.getAttribute('data-periodicidad') || '';
          const fechaProxima = btnEditProg.getAttribute('data-fecha-proxima') || '';
          const fechaUltima  = btnEditProg.getAttribute('data-fecha-ultima') || '';

          const bodyHTML = `
            <div class="grid">
              <div>
                <label>Periodicidad (días)</label>
                <input id="edit_periodicidad" type="number" min="1" max="365" value="${periodicidad}" />
              </div>
              <div>
                <label>Fecha próxima</label>
                <input id="edit_fecha_proxima" type="date" value="${fechaProxima}" />
              </div>
              <div style="grid-column: span 2;">
                <label>Fecha última (opcional)</label>
                <input id="edit_fecha_ultima" type="date" value="${fechaUltima}" />
              </div>
            </div>
          `;
          openModal('Editar programación #' + id, bodyHTML, async (msg) => {
            const payload = {
              periodicidad_dias: parseInt(document.getElementById('edit_periodicidad').value),
              fecha_proxima: document.getElementById('edit_fecha_proxima').value || null,
              fecha_ultima:  document.getElementById('edit_fecha_ultima').value || null
            };
            if (!payload.periodicidad_dias || !payload.fecha_proxima) {
              throw new Error('Faltan campos obligatorios');
            }
            await fetchJSON('/programaciones/' + id, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            await cargarProximas();
          });
          return;
        }

        // ELIMINAR programación
        const btnDelProg = ev.target.closest('.btn-del-prog');
        if (btnDelProg) {
          const id = btnDelProg.getAttribute('data-id');
          if (!id) return;
          if (!confirm('¿Eliminar programación ID ' + id + '?')) return;
          const msg = document.getElementById('prox_msg');
          msg.textContent = 'Eliminando...';
          try {
            await fetchJSON('/programaciones/' + id, { method: 'DELETE' });
            msg.textContent = 'Programación eliminada';
            await cargarProximas();
          } catch (e2) {
            msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
          }
          return;
        }

        // EDITAR mantenimiento
        const btnEditMant = ev.target.closest('.btn-edit-mant');
        if (btnEditMant) {
          const id = btnEditMant.getAttribute('data-id');
          const tipo = btnEditMant.getAttribute('data-tipo') || 'preventivo';
          const estado = btnEditMant.getAttribute('data-estado') || 'abierto';
          const apertura = (btnEditMant.getAttribute('data-apertura') || '').replace(' ', 'T').slice(0,16);
          const cierre   = (btnEditMant.getAttribute('data-cierre') || '').replace(' ', 'T').slice(0,16);
          const desc     = btnEditMant.getAttribute('data-desc') || '';

          const bodyHTML = `
            <div class="grid">
              <div>
                <label>Tipo</label>
                <select id="edit_mant_tipo">
                  <option ${tipo==='preventivo'?'selected':''}>preventivo</option>
                  <option ${tipo==='correctivo'?'selected':''}>correctivo</option>
                </select>
              </div>
              <div>
                <label>Estado</label>
                <select id="edit_mant_estado">
                  <option ${estado==='abierto'?'selected':''}>abierto</option>
                  <option ${estado==='en_proceso'?'selected':''}>en_proceso</option>
                  <option ${estado==='cerrado'?'selected':''}>cerrado</option>
                </select>
              </div>
              <div>
                <label>Apertura</label>
                <input id="edit_mant_apertura" type="datetime-local" value="${apertura}" />
              </div>
              <div>
                <label>Cierre (opcional)</label>
                <input id="edit_mant_cierre" type="datetime-local" value="${cierre}" />
              </div>
              <div style="grid-column: span 2;">
                <label>Descripción</label>
                <input id="edit_mant_desc" value="${desc}" />
              </div>
            </div>
          `;
          openModal('Editar mantenimiento #' + id, bodyHTML, async (msg) => {
            const payload = {
              tipo: document.getElementById('edit_mant_tipo').value,
              estado: document.getElementById('edit_mant_estado').value,
              fecha_apertura: toMySQLDateTime(document.getElementById('edit_mant_apertura').value),
              fecha_cierre: toMySQLDateTime(document.getElementById('edit_mant_cierre').value) || null,
              descripcion: document.getElementById('edit_mant_desc').value || null
            };
            if (!payload.tipo || !payload.fecha_apertura) throw new Error('Faltan campos obligatorios');
            await fetchJSON('/mantenimientos/' + id, {
              method: 'PUT', headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            await cargarMantenimientos();
          });
          return;
        }

        // ELIMINAR mantenimiento
        const btnDelMant = ev.target.closest('.btn-del-mant');
        if (btnDelMant) {
          const id = btnDelMant.getAttribute('data-id');
          if (!id) return;
          if (!confirm('¿Eliminar mantenimiento ID ' + id + '?')) return;
          const msg = document.getElementById('mant_msg');
          msg.textContent = 'Eliminando...';
          try {
            await fetchJSON('/mantenimientos/' + id, { method: 'DELETE' });
            msg.textContent = 'Mantenimiento eliminado';
            await cargarMantenimientos();
          } catch (e2) {
            msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
          }
          return;
        }

        // EDITAR incidencia
        const btnEditInc = ev.target.closest('.btn-edit-inc');
        if (btnEditInc) {
          const id = btnEditInc.getAttribute('data-id');
          const sev = btnEditInc.getAttribute('data-sev') || 'media';
          const fecha = btnEditInc.getAttribute('data-fecha') || '';
          const desc  = btnEditInc.getAttribute('data-desc') || '';
          const mant  = btnEditInc.getAttribute('data-mant') || '';

          const bodyHTML = `
            <div class="grid">
              <div>
                <label>Severidad</label>
                <select id="edit_inc_sev">
                  <option ${sev==='baja'?'selected':''}>baja</option>
                  <option ${sev==='media'?'selected':''}>media</option>
                  <option ${sev==='alta'?'selected':''}>alta</option>
                </select>
              </div>
              <div>
                <label>Fecha reporte</label>
                <input id="edit_inc_fecha" type="datetime-local" value="${fecha}" />
              </div>
              <div style="grid-column: span 2;">
                <label>Descripción</label>
                <input id="edit_inc_desc" value="${desc}" />
              </div>
              <div>
                <label>Mantenimiento (ID)</label>
                <input id="edit_inc_mant" type="number" min="1" value="${mant}" />
              </div>
            </div>
          `;
          openModal('Editar incidencia #' + id, bodyHTML, async (msg) => {
            const payload = {
              severidad: document.getElementById('edit_inc_sev').value,
              fecha_reporte: toMySQLDateTime(document.getElementById('edit_inc_fecha').value),
              descripcion: document.getElementById('edit_inc_desc').value || null,
              mantenimiento_id: parseInt(document.getElementById('edit_inc_mant').value) || null
            };
            if (!payload.severidad || !payload.fecha_reporte) throw new Error('Faltan campos obligatorios');
            await fetchJSON('/incidencias/' + id, {
              method: 'PUT', headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            await cargarIncidencias();
          });
          return;
        }

        // ELIMINAR incidencia
        const btnDelInc = ev.target.closest('.btn-del-inc');
        if (btnDelInc) {
          const id = btnDelInc.getAttribute('data-id');
          if (!id) return;
          if (!confirm('¿Eliminar incidencia ID ' + id + '?')) return;
          const msg = document.getElementById('inc_msg');
          msg.textContent = 'Eliminando...';
          try {
            await fetchJSON('/incidencias/' + id, { method: 'DELETE' });
            msg.textContent = 'Incidencia eliminada';
            await cargarIncidencias();
          } catch (e2) {
            msg.textContent = 'Error: ' + (e2.payload?.error ?? e2.message ?? 'desconocido');
          }
          return;
        }

        // EDITAR equipo
        const btnEditEq = ev.target.closest('.btn-edit-eq');
        if (btnEditEq) {
          const id = btnEditEq.getAttribute('data-id');
          const tr = btnEditEq.closest('tr');
          const etiqueta = tr.children[1].textContent.trim();
          const tipo     = tr.children[2].textContent.trim();
          const marca    = tr.children[3].textContent.trim();
          const modelo   = tr.children[4].textContent.trim();
          const estado   = tr.children[5].textContent.trim();
          const laboratorioIdActual = btnEditEq.getAttribute('data-labid') || '';

          const bodyHTML = `
            <div class="grid">
              <div>
                <label>Etiqueta (única)</label>
                <input id="edit_etiqueta" value="${etiqueta}" />
              </div>
              <div>
                <label>Laboratorio</label>
                <select id="edit_lab"></select>
              </div>
              <div>
                <label>Tipo</label>
                <input id="edit_tipo" value="${tipo}" />
              </div>
              <div>
                <label>Marca</label>
                <input id="edit_marca" value="${marca}" />
              </div>
              <div>
                <label>Modelo</label>
                <input id="edit_modelo" value="${modelo}" />
              </div>
              <div>
                <label>Estado</label>
                <select id="edit_estado">
                  <option ${estado==='operativo'?'selected':''}>operativo</option>
                  <option ${estado==='programado'?'selected':''}>programado</option>
                  <option ${estado==='en_mantenimiento'?'selected':''}>en_mantenimiento</option>
                  <option ${estado==='de_baja'?'selected':''}>de_baja</option>
                </select>
              </div>
            </div>
          `;
          openModal('Editar equipo #' + id, bodyHTML, async (msg) => {
            const etiqueta = document.getElementById('edit_etiqueta').value.trim();
            const labId    = parseInt(document.getElementById('edit_lab').value);
            const payload = {
              etiqueta_activo: etiqueta,
              laboratorio_id: labId,
              tipo:  document.getElementById('edit_tipo').value.trim() || null,
              marca: document.getElementById('edit_marca').value.trim() || null,
              modelo:document.getElementById('edit_modelo').value.trim() || null,
              estado:document.getElementById('edit_estado').value
            };
            if (!payload.etiqueta_activo || !payload.laboratorio_id) {
              throw new Error('Faltan campos obligatorios');
            }

            await fetchJSON('/equipos/' + id, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            await cargarEquipos();
            await cargarCombosAdmin();
          });

          // Cargar labs en el select del modal y seleccionar el actual por ID
          (async () => {
            const labs = await fetchJSON('/laboratorios');
            const sel = document.getElementById('edit_lab');
            sel.innerHTML = labs.map(l => `<option value="${l.id}">${l.nombre}</option>`).join('');
            if (laboratorioIdActual) sel.value = laboratorioIdActual;
          })();
          return;
        }

        // ELIMINAR equipo
        const btnDelEq = ev.target.closest('.btn-del-eq');
        if (btnDelEq) {
          const id = btnDelEq.getAttribute('data-id');
          if (!id) return;
          if (!confirm('¿Eliminar equipo ID ' + id + '?')) return;

          const msg = document.getElementById('eq_msg');
          msg.textContent = 'Eliminando...';
          try {
            await fetchJSON('/equipos/' + id, { method: 'DELETE' });
            msg.textContent = 'Equipo eliminado';
            await cargarEquipos();
            await cargarCombosAdmin();
          } catch (e) {
            msg.textContent = 'Error: ' + (e.payload?.error ?? e.message ?? 'desconocido');
          }
          return;
        }
      });
    }

    // Inicialización
    async function init() {
      try {
        const info = await me();
        if (!info.autenticado) { window.location.href='/login-ui'; return; }
        ROL = info.usuario.rol || 'solo_vista';
        document.getElementById('user').textContent =
          `Sesión: ${info.usuario.usuario} [${ROL}]`;

        // Cargar catálogos y datos
        await cargarLaboratorios('eq_lab');
        await cargarEquipos();

        await cargarLaboratorios('prox_lab');
        await cargarProximas();

        // Paneles Mantenimientos / Incidencias
        await cargarMantenimientos();
        await cargarIncidencias();

        // Rol: mostrar/ocultar paneles admin y cargar combos
        toggleAdminPanels(ROL);
        if (ROL === 'admin') {
          await cargarCombosAdmin();
        }

        // Bind de eventos (solo una vez)
        bindEventsOnce();

      } catch (e) {
        // Si /me falló o devolvió no autenticado
        window.location.href = '/login-ui';
      }
    }
    init();
  </script>
</body>
</html>
